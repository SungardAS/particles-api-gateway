---
resourceId: "EC2"
resourcePath: "ec2"
methods:
  -
    method: "GET"
    authType: "NONE"
    requestParameters: {"method.request.header.external-id":true}
    lambdaArn: ""
    requestTemplates: {
      "application/json": "{\n  \"federateRoleArn\": \"$input.params('federateRoleArn')\",\n  \"accountRoleArn\": \"$input.params('accountRoleArn')\",\n  \"externalId\": \"$input.params('externalId')\"\n}\n"
    }
  -
    method: "POST"
    authType: "NONE"
    requestParameters: {"method.request.header.external-id":true}
    lambdaArn: ""
    requestTemplates: {
      "application/json": "{\n  \"federateRoleArn\": \"$input.params('federateRoleArn')\",\n  \"accountRoleArn\": \"$input.params('accountRoleArn')\",\n  \"externalId\": \"$input.params('externalId')\"\n}\n"
    }
statusCodes:
  -
    pattern: ""
    code: "200"
  -
    pattern: "not permitted.*"
    code: "401"
  -
    pattern: "unauthorized.*"
    code: "403"
contentType: "application/json"
allowedMethods: "'GET,POST,OPTIONS'"
allowedHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,external-id'"
allowedOrigin: "'*'"
---

{{
   parameter "m:core" "base"
   logicalId="LambdaInvokeRoleArn"
   type="String"
   description="ARN of IAM role that can invoke lambda functions"
}}

{{
  parameter "m:core" "base"
  logicalId="RestApiId"
  type="String"
  description="API Id"
}}

{{
  parameter "m:core" "base"
  logicalId="ParentResourceId"
  type="String"
  description="Parent Resource Id"
}}


{{#resource logicalId=resourceId}}
  "Type" : "AWS::ApiGateway::Resource",
  "Properties" : {
    "RestApiId": { "Ref": "RestApiId" },
    "ParentId": { "Ref": "ParentResourceId" },
    "PathPart": {{helper "m:core" "propertyValue" resourcePath}}
  }
{{/resource}}

{{#each methods}}

  {{#resource logicalId=(concat resourceId this.method)}}
    "Type" : "AWS::ApiGateway::Method",
    "Properties" : {
      "RestApiId": { "Ref": "RestApiId" },
      "ResourceId": (ref resourceId),
      "HttpMethod": this.method,
      "AuthorizationType": this.authType,
      {{#if this.requestParameters}}
        "RequestParameters": this.requestParameters
      {{/if}}
      "Integration": {
        "Credentials": { "Ref": "LambdaInvokeRoleArn" },
        "IntegrationHttpMethod": "POST",
        "Type": "AWS",
        "Uri": concat("arn:aws:apigateway:" (ref "AWS::Region") ":lambda:path/2015-03-31/functions/" this.lambdaArn "/invocations"),
        "RequestTemplates": this.requestTemplates,
        {{{ set 'integration_responses' }}}
      },
      {{{ set 'method_responses' }}}
    }
  {{/resource}}

  {{#resource logicalId=(concat resourceId "Options")}}
    "Type" : "AWS::ApiGateway::Method",
    "Properties" : {
      "RestApiId": { "Ref": "RestApiId" },
      "ResourceId": (ref resourceId),
      "HttpMethod": "OPTIONS",
      "AuthorizationType": "NONE",
      "Integration": {
        "Type": "MOCK",
        "RequestTemplates": {"application/json": "{\"statusCode\": 200}" },
        {{{ set 'integration_responses'
          statusCodes=statusCodes
          allowedMethods=allowedMethods
          allowedHeaders=allowedHeaders
        }}}
      },
      {{{ set 'method_responses'
        statusCodes=statusCodes
        contentType=contentType
        allowedMethods=allowedMethods
        allowedHeaders=allowedHeaders
      }}}
    }
  {{/resource}}

{{/each}}
